name: 💿 St1_Build-Rootfs-release+appfilter
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "请选择初始网络配置"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: '请输入管理IP（静态地址时必填）'
        required: true
        default: '192.168.5.88'
      gateway:
        description: '请输入默认网关（静态地址时必填）'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: "是否集成Docker插件"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: ⚙️ 设置可执行权限
      run: | 
        chmod +x arm64/build24.sh
        chmod +x shell/*.sh

    - name: ⚙️ 设置IP和网关
      run: |
        echo "当前网络配置路径"
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        echo $CONFIG_PATH
        if [ "${{ inputs.network_settings }}" = "static" ]; then
           echo "删除网络设置-dhcp"
           sed -i '44,105d' "$CONFIG_PATH"
           echo "替换默认配置"
           sed -i "/ipaddr/s/192.168.5.88/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"
           sed -i "/gateway/s/192.168.5.1/${{ inputs.gateway }}/g" "$CONFIG_PATH"
        else
           echo "删除网络设置-static"
           sed -i '36,42d' "$CONFIG_PATH"
        fi
        echo "输出配置"
        cat $CONFIG_PATH

    - name: ⏬ 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl unzip tree git

    - name: ⏬ 下载 ImageBuilder
      run: |
        curl -L -o imagebuilder.tar.zst https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv istoreos-imagebuilder-* imagebuilder

    - name: ⏬ 克隆 OpenAppFilter 插件
      run: |
        git clone https://github.com/destan19/OpenAppFilter.git openappfilter
        mkdir -p imagebuilder/package/openappfilter
        cp -r openappfilter/* imagebuilder/package/openappfilter/

    - name: ⏬ 复制并设置必备文件
      run: |
        cp arm64/{build24.sh,Makefile} imagebuilder/
        cp shell/{prepare-packages.sh,custom-packages.sh} imagebuilder/
        find files/packages/ -name "*.ipk" -exec cp {} imagebuilder/packages/ \;
        
        mkdir -p imagebuilder/files/etc/{uci-defaults,opkg,banner1}
        cp files/etc/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        cp files/etc/opkg/distfeeds.conf imagebuilder/files/etc/opkg/
        cp files/etc/banner imagebuilder/files/etc/banner1/
        mkdir -p imagebuilder/files/etc/openclash/core
        cp files/etc/openclash/core/clash_meta imagebuilder/files/etc/openclash/core/
        cp files/etc/rc.local imagebuilder/files/etc/
        
        cd imagebuilder
        # 启用rootfs.tar.gz配置
        sed -i 's/# CONFIG_TARGET_ROOTFS_TARGZ is not set/CONFIG_TARGET_ROOTFS_TARGZ=y/' .config
        sed -i "s|CONFIG_TARGET_ROOTFS_SQUASHFS=.*|# CONFIG_TARGET_ROOTFS_SQUASHFS is not set|g" .config
        sed -i "s|CONFIG_TARGET_IMAGES_GZIP=.*|# CONFIG_TARGET_IMAGES_GZIP is not set|g" .config
        
        # 启用OpenAppFilter相关组件
        echo "CONFIG_PACKAGE_oaf=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-oaf-zh-cn=y" >> .config

    - name: 🧱 构建iStoreOS-rootfs和插件
      working-directory: ./imagebuilder
      run: |
        echo "开始编译，输出详细日志..."
        bash ./build24.sh
        # 查看编译产物目录结构（调试用）
        tree -L 3 bin/
        tree -L 3 packages/

    - name: 📌 收集所有OpenAppFilter相关IPK文件
      id: collect_ipks
      run: |
        mkdir -p openappfilter_ipk
        # 搜索所有OpenAppFilter相关IPK（包含oaf前缀和openappfilter关键字）
        find imagebuilder/ -type f -name "*openappfilter*.ipk" -exec cp {} openappfilter_ipk/ \; -print 2>/dev/null
        find imagebuilder/ -type f -name "oaf*.ipk" -exec cp {} openappfilter_ipk/ \; -print 2>/dev/null
        
        # 检查收集结果
        echo "收集到的IPK文件："
        ls -l openappfilter_ipk/
        if [ -z "$(ls -A openappfilter_ipk/)" ]; then
          echo "警告：未找到OpenAppFilter相关IPK文件，可能编译失败"
        fi
        
        # 输出文件路径
        echo "ipk_files=openappfilter_ipk/*.ipk" >> $GITHUB_OUTPUT

    - name: 📦 打印产出rootfs
      run: |
        echo "rootfs产物目录："
        ls -lah imagebuilder/bin/targets/armsr/armv8/

    - name: 🚀 上传到 Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-24.10-RELEASE-${{ inputs.network_settings }}
        body: |
          📌 版本： iStoreOS-24.10.2-RELEASE（imagebuilder构建，稳定版）
          
          📂 来源： https://fw.koolcenter.com/iStoreOS/ib/armsr/
          
          🧠 内核： Please Login to iStoreOS → System → Amlogic Service → Replace the Kernel
          
          🧩 集成： 基础组件、驱动、网络工具、容器支持及OpenAppFilter插件
          
          🆕 附加： 所有OpenAppFilter相关IPK文件（自动收集）
          
          👤 用户名： root | 密码： 无
          
          🌐 IP： ${{ inputs.network_settings == 'static' && inputs.ipaddr || '单网口-动态获取；多网口-192.168.100.1' }}
        files: |
          imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz
          ${{ steps.collect_ipks.outputs.ipk_files }}
      env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
