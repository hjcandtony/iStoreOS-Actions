name: ğŸ’¿ OpenAppFilter
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'ç®¡ç†IPï¼ˆé™æ€å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.88'
      gateway:
        description: 'é»˜è®¤ç½‘å…³ï¼ˆé™æ€å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: "é›†æˆDocker"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
      run: | 
        chmod +x arm64/build24.sh
        chmod +x shell/*.sh

    - name: âš™ï¸ é…ç½®ç½‘ç»œå‚æ•°
      run: |
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        if [ "${{ inputs.network_settings }}" = "static" ]; then
          sed -i '44,105d' "$CONFIG_PATH"
          sed -i "/ipaddr/s/192.168.5.88/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"
          sed -i "/gateway/s/192.168.5.1/${{ inputs.gateway }}/g" "$CONFIG_PATH"
        else
          sed -i '36,42d' "$CONFIG_PATH"
        fi
        cat $CONFIG_PATH

    - name: â¬ å®‰è£…ä¾èµ–å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl unzip tree git

    - name: â¬ ä¸‹è½½ImageBuilder
      run: |
        curl -L -o imagebuilder.tar.zst https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv istoreos-imagebuilder-* imagebuilder

    - name: â¬ å…‹éš†OpenAppFilteræºç 
      run: |
        git clone https://github.com/destan19/OpenAppFilter.git openappfilter
        mkdir -p imagebuilder/package/openappfilter
        cp -r openappfilter/* imagebuilder/package/openappfilter/

    - name: âš™ï¸ é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆå…³é”®ä¿®å¤ï¼‰
      run: |
        # å¤åˆ¶åŸºç¡€æ–‡ä»¶
        cp arm64/{build24.sh,Makefile} imagebuilder/
        cp shell/{prepare-packages.sh,custom-packages.sh} imagebuilder/
        find files/packages/ -name "*.ipk" -exec cp {} imagebuilder/packages/ \;
        
        # åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p imagebuilder/files/etc/{uci-defaults,opkg,banner1,openclash/core}
        cp files/etc/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        cp files/etc/opkg/distfeeds.conf imagebuilder/files/etc/opkg/
        cp files/etc/banner imagebuilder/files/etc/banner1/
        cp files/etc/openclash/core/clash_meta imagebuilder/files/etc/openclash/core/
        cp files/etc/rc.local imagebuilder/files/etc/
        
        # è¿›å…¥imagebuilderç›®å½•é…ç½®ç¼–è¯‘é€‰é¡¹
        cd imagebuilder
        
        # å¯ç”¨rootfs.tar.gz
        sed -i 's/# CONFIG_TARGET_ROOTFS_TARGZ is not set/CONFIG_TARGET_ROOTFS_TARGZ=y/' .config
        sed -i "s|CONFIG_TARGET_ROOTFS_SQUASHFS=.*|# CONFIG_TARGET_ROOTFS_SQUASHFS is not set|g" .config
        sed -i "s|CONFIG_TARGET_IMAGES_GZIP=.*|# CONFIG_TARGET_IMAGES_GZIP is not set|g" .config
        
        # å¼ºåˆ¶å¯ç”¨OpenAppFilterå…¨ç»„ä»¶ï¼ˆå…³é”®ä¿®å¤ç‚¹1ï¼‰
        echo "CONFIG_PACKAGE_appfilter=y" >> .config
        echo "CONFIG_PACKAGE_oaf=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-oaf-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-appfilter=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-appfilter-zh-cn=y" >> .config

    - name: ğŸ› ï¸ ä¿®æ”¹build24.shå¯ç”¨OAFï¼ˆå…³é”®ä¿®å¤ç‚¹2ï¼‰
      run: |
        # è§£é™¤build24.shä¸­OAFç›¸å…³åŒ…çš„æ³¨é‡Š
        sed -i 's/#PACKAGES="$PACKAGES luci-i18n-oaf-zh-cn"/PACKAGES="$PACKAGES luci-i18n-oaf-zh-cn"/g' imagebuilder/build24.sh
        sed -i 's/#PACKAGES="$PACKAGES luci-app-oaf"/PACKAGES="$PACKAGES luci-app-oaf"/g' imagebuilder/build24.sh
        sed -i 's/#PACKAGES="$PACKAGES appfilter"/PACKAGES="$PACKAGES appfilter"/g' imagebuilder/build24.sh
        # æ·»åŠ ç¼ºå¤±çš„appfilterç›¸å…³åŒ…
        echo 'PACKAGES="$PACKAGES oaf"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES luci-app-appfilter"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES luci-i18n-appfilter-zh-cn"' >> imagebuilder/build24.sh

    - name: ğŸ§± æ„å»ºç³»ç»Ÿå’Œæ’ä»¶
      working-directory: ./imagebuilder
      run: |
        echo "å¼€å§‹ç¼–è¯‘ï¼Œæ˜¾ç¤ºè¯¦ç»†è¿‡ç¨‹..."
        bash ./build24.sh
        # æ˜¾ç¤ºç¼–è¯‘äº§ç‰©ç»“æ„ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
        tree -L 4 bin/
        tree -L 4 packages/

    - name: ğŸ“Œ æ”¶é›†æ‰€æœ‰OAFç›¸å…³IPKï¼ˆå¢å¼ºç‰ˆï¼‰
      id: collect_ipks
      run: |
        mkdir -p openappfilter_ipk
        # å¤šæ¨¡å¼åŒ¹é…ç¡®ä¿æ‰€æœ‰ç›¸å…³IPKè¢«æ”¶é›†
        find imagebuilder/ -type f -name "appfilter*.ipk" -exec cp {} openappfilter_ipk/ \; -print
        find imagebuilder/ -type f -name "oaf*.ipk" -exec cp {} openappfilter_ipk/ \; -print
        find imagebuilder/ -type f -name "luci-app-oaf*.ipk" -exec cp {} openappfilter_ipk/ \; -print
        find imagebuilder/ -type f -name "luci-i18n-oaf*.ipk" -exec cp {} openappfilter_ipk/ \; -print
        find imagebuilder/ -type f -name "luci-app-appfilter*.ipk" -exec cp {} openappfilter_ipk/ \; -print
        find imagebuilder/ -type f -name "luci-i18n-appfilter*.ipk" -exec cp {} openappfilter_ipk/ \; -print
        find imagebuilder/ -type f -name "*.ipk" -exec cp {} openappfilter_ipk/ \; -print
        find imagebuilder/ -type f -name "*.ko" -exec cp {} openappfilter_ipk/ \; -print
        
        # æ£€æŸ¥æ”¶é›†ç»“æœ
        echo "æ”¶é›†åˆ°çš„IPKæ–‡ä»¶ï¼š"
        ls -l openappfilter_ipk/
        if [ -z "$(ls -A openappfilter_ipk/)" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°OpenAppFilterç›¸å…³IPKï¼Œè¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—"
          exit 1
        fi
        echo "ipk_files=openappfilter_ipk/*.ipk" >> $GITHUB_OUTPUT
        echo "ipk_files=openappfilter_ipk/*.ko" >> $GITHUB_OUTPUT

    - name: ğŸš€ ä¸Šä¼ äº§ç‰©åˆ°Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-24.10-OAF-${{ inputs.network_settings }}
        body: |
          ğŸ“Œ ç‰ˆæœ¬ï¼šiStoreOS-24.10.2 å¸¦OpenAppFilterå®Œæ•´ç‰ˆ
          ğŸ§© å·²ç¡®è®¤åŒ…å«ï¼š
          - appfilter åŸºç¡€ç»„ä»¶
          - oaf æ ¸å¿ƒæ¨¡å—
          - luci-app-oaf ç®¡ç†ç•Œé¢
          - luci-i18n-oaf-zh-cn ä¸­æ–‡è¯­è¨€åŒ…
          - luci-app-appfilter æ‰©å±•ç•Œé¢
          - luci-i18n-appfilter-zh-cn æ‰©å±•ä¸­æ–‡åŒ…
        files: |
          imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz
          ${{ steps.collect_ipks.outputs.ipk_files }}
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
