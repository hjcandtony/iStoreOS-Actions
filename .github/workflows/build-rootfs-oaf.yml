name: ğŸ”§ OpenWrtè§„èŒƒç¼–è¯‘OAF
on:
  workflow_dispatch:
    inputs:
      network_mode:
        description: "ç½‘ç»œæ¨¡å¼"
        required: true
        default: "dhcp"
        type: choice
        options:
          - dhcp
          - static

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: å‡†å¤‡ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev zstd curl git libssl-dev unzip

      - name: ä¸‹è½½å¹¶åˆå§‹åŒ–ImageBuilder
        run: |
          # ä¸‹è½½å®˜æ–¹ImageBuilder
          IMAGEBUILDER_URL="https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          curl -L -o imagebuilder.tar.zst "$IMAGEBUILDER_URL"
          mkdir -p imagebuilder
          tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst -C imagebuilder --strip-components=1
          
          # åˆå§‹åŒ–feedsç³»ç»Ÿï¼ˆå…³é”®æ­¥éª¤ï¼‰
          cd imagebuilder
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: æ­£ç¡®æ”¾ç½®OAFç»„ä»¶ï¼ˆç¬¦åˆOpenWrtè§„èŒƒï¼‰
        run: |
          # å…‹éš†OAFæºç 
          git clone --depth 1 https://github.com/destan19/OpenAppFilter.git oaf-source
          
          # OpenWrtè¦æ±‚æ¯ä¸ªåŒ…å¿…é¡»ç›´æ¥æ”¾åœ¨packageç›®å½•ä¸‹
          # é”™è¯¯æ–¹å¼ï¼špackage/OpenAppFilter/luci-app-oaf
          # æ­£ç¡®æ–¹å¼ï¼špackage/luci-app-oaf
          
          # ç§»åŠ¨ç»„ä»¶åˆ°æ­£ç¡®ä½ç½®
          cd oaf-source
          for pkg in luci-app-oaf oaf open-app-filter; do
            mv "$pkg" ../imagebuilder/package/
          done
          cd ..
          
          # éªŒè¯ç›®å½•ç»“æ„ï¼ˆå¿…é¡»ç›´æ¥åœ¨packageä¸‹ï¼‰
          echo "éªŒè¯OAFç»„ä»¶ç›®å½•ç»“æ„ï¼š"
          ls -la imagebuilder/package/luci-app-oaf
          ls -la imagebuilder/package/oaf
          ls -la imagebuilder/package/open-app-filter

      - name: æ£€æŸ¥Makefileå®Œæ•´æ€§
        run: |
          # éªŒè¯å…³é”®Makefileå­˜åœ¨
          for pkg in luci-app-oaf oaf open-app-filter; do
            if [ ! -f "imagebuilder/package/$pkg/Makefile" ]; then
              echo "é”™è¯¯ï¼š$pkg ç¼ºå¤±Makefile"
              exit 1
            fi
            # éªŒè¯MakefileåŒ…å«ç¼–è¯‘è§„åˆ™
            if ! grep -q "define Package/$pkg/compile" "imagebuilder/package/$pkg/Makefile"; then
              echo "é”™è¯¯ï¼š$pkg çš„Makefileç¼ºå¤±ç¼–è¯‘è§„åˆ™"
              exit 1
            fi
          done

      - name: é…ç½®ç¼–è¯‘é€‰é¡¹
        run: |
          cd imagebuilder
          
          # ç”Ÿæˆé»˜è®¤é…ç½®
          make defconfig
          
          # å¯ç”¨OAFç»„ä»¶
          echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
          echo "CONFIG_PACKAGE_oaf=y" >> .config
          echo "CONFIG_PACKAGE_open-app-filter=y" >> .config
          
          # åº”ç”¨é…ç½®
          make defconfig

      - name: ç¼–è¯‘OAFç»„ä»¶ï¼ˆæœ€ç»ˆæ–¹æ¡ˆï¼‰
        working-directory: ./imagebuilder
        run: |
          # å…ˆæ›´æ–°åŒ…ç´¢å¼•
          make package/index V=s
          
          # ç¼–è¯‘ç»„ä»¶ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
          make package/luci-app-oaf/compile V=s
          make package/oaf/compile V=s
          make package/open-app-filter/compile V=s

      - name: æ„å»ºæœ€ç»ˆé•œåƒ
        working-directory: ./imagebuilder
        run: |
          make image V=s
          find bin/targets/ -name "*rootfs.tar.gz" -exec cp {} ../ \;

      - name: ä¸Šä¼ ç»“æœ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: oaf-correct-structure-${{ github.run_id }}
          files: "*.tar.gz"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
