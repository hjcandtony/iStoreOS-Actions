name: ğŸ’¿ 1114St1_Build-Rootfs-release-oaf
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IPï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.88'
      gateway:
        description: 'è¯·è¾“å…¥é»˜è®¤ç½‘å…³ï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: "æ˜¯å¦é›†æˆDockeræ’ä»¶"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
      run: | 
        chmod +x arm64/build24.sh
        chmod +x shell/*.sh

    - name: âš™ï¸ è®¾ç½®IPå’Œç½‘å…³
      run: |
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        echo "å½“å‰ç½‘ç»œé…ç½®è·¯å¾„ï¼š$CONFIG_PATH"
        if [ ! -f "$CONFIG_PATH" ]; then
          echo "é”™è¯¯ï¼šç½‘ç»œé…ç½®æ–‡ä»¶ $CONFIG_PATH ä¸å­˜åœ¨"
          exit 1
        fi
        if [ "${{ inputs.network_settings }}" = "static" ]; then
           sed -i '44,105d' "$CONFIG_PATH"
           sed -i "/ipaddr/s/192.168.5.88/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"
           sed -i "/gateway/s/192.168.5.1/${{ inputs.gateway }}/g" "$CONFIG_PATH"
        else
           sed -i '36,42d' "$CONFIG_PATH"
        fi
        cat "$CONFIG_PATH"

    - name: â¬ å®‰è£…å®Œæ•´ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libncurses5-dev zstd curl unzip tree git \
          libssl-dev python3-distutils libgmp3-dev libmpc-dev file \
          rsync  # æ–°å¢rsyncç”¨äºå¯é å¤åˆ¶æ–‡ä»¶

    - name: â¬ ä¸‹è½½å¹¶é…ç½®iStoreOS ImageBuilder
      run: |
        # ä¸‹è½½ImageBuilder
        IMAGEBUILDER_URL="https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
        curl -L -o imagebuilder.tar.zst "$IMAGEBUILDER_URL"
        
        # è§£å‹å¹¶å¤„ç†ç›®å½•ç»“æ„
        mkdir -p imagebuilder
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst -C imagebuilder --strip-components=1
        
        # ç¡®ä¿æ ¸å¿ƒç›®å½•å­˜åœ¨
        for dir in "package" "bin" "build_dir" "feeds" "target"; do
          if [ ! -d "imagebuilder/$dir" ]; then
            echo "åˆ›å»ºç¼ºå¤±çš„$dirç›®å½•"
            mkdir -p "imagebuilder/$dir"
          fi
        done
        
        # éªŒè¯ImageBuilderå®Œæ•´æ€§
        if [ ! -f "imagebuilder/Makefile" ] || [ ! -f "imagebuilder/rules.mk" ]; then
          echo "é”™è¯¯ï¼šImageBuilderæ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼ˆMakefileæˆ–rules.mkï¼‰"
          exit 1
        fi

    - name: â¬ å…‹éš†å¹¶ä¿®å¤OpenAppFilteræºç ï¼ˆç¬¦åˆOpenWrtè§„èŒƒï¼‰
      run: |
        # å…‹éš†æºç ï¼ˆæŒ‡å®šåˆ†æ”¯ç¡®ä¿ç¨³å®šæ€§ï¼‰
        git clone --depth 1 https://github.com/destan19/OpenAppFilter.git temp_oaf
        
        # å®šä¹‰å¿…è¦ç»„ä»¶
        OAF_COMPONENTS=("luci-app-oaf" "oaf" "open-app-filter")
        OAF_PACKAGE_DIR="imagebuilder/package"
        
        # å¤åˆ¶å¹¶ä¿®å¤æ¯ä¸ªç»„ä»¶
        for comp in "${OAF_COMPONENTS[@]}"; do
          # 1. éªŒè¯æºç»„ä»¶å­˜åœ¨
          SRC_DIR="temp_oaf/$comp"
          if [ ! -d "$SRC_DIR" ]; then
            echo "é”™è¯¯ï¼šOAFæºç»„ä»¶ $comp ç¼ºå¤±ï¼ˆè·¯å¾„ï¼š$SRC_DIRï¼‰"
            exit 1
          fi
          
          # 2. å¤åˆ¶ç»„ä»¶åˆ°packageç›®å½•ï¼ˆä½¿ç”¨rsyncç¡®ä¿æƒé™å’Œç»“æ„ï¼‰
          DST_DIR="$OAF_PACKAGE_DIR/$comp"
          rsync -av "$SRC_DIR/" "$DST_DIR/"
          
          # 3. éªŒè¯å…³é”®æ–‡ä»¶ï¼ˆå¿…é¡»å­˜åœ¨Makefileå’Œæ­£ç¡®ç»“æ„ï¼‰
          if [ ! -f "$DST_DIR/Makefile" ]; then
            echo "é”™è¯¯ï¼šç»„ä»¶ $comp ç¼ºå¤±Makefileï¼ˆè·¯å¾„ï¼š$DST_DIR/Makefileï¼‰"
            exit 1
          fi
          
          # 4. ä¿®å¤Makefileä¸­çš„å¯èƒ½è·¯å¾„é—®é¢˜ï¼ˆé€‚é…ImageBuilderï¼‰
          sed -i "s|$(TOPDIR)/package/OpenAppFilter/|$(TOPDIR)/package/|g" "$DST_DIR/Makefile"
          
          # 5. éªŒè¯ä¿®å¤ç»“æœ
          echo "ç»„ä»¶ $comp éªŒè¯é€šè¿‡ï¼Œç›®å½•ç»“æ„ï¼š"
          ls -la "$DST_DIR"
        done
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf temp_oaf
        
        # ç”Ÿæˆpackageç´¢å¼•ï¼ˆå…³é”®ï¼šè®©ImageBuilderè¯†åˆ«æ–°ç»„ä»¶ï¼‰
        cd imagebuilder
        make package/index V=s
        
        # éªŒè¯ç»„ä»¶æ˜¯å¦è¢«è¯†åˆ«
        echo "ImageBuilderè¯†åˆ«çš„OAFç»„ä»¶ï¼š"
        grep -E "luci-app-oaf|oaf|open-app-filter" package/index | cut -d' ' -f1

    - name: â¬ é…ç½®ImageBuilderç¼–è¯‘é€‰é¡¹
      run: |
        cd imagebuilder
        
        # é‡ç½®OAFç›¸å…³é…ç½®
        sed -i '/CONFIG_PACKAGE_luci-app-oaf/d' .config
        sed -i '/CONFIG_PACKAGE_oaf/d' .config
        sed -i '/CONFIG_PACKAGE_open-app-filter/d' .config
        
        # å¼ºåˆ¶å¯ç”¨OAFç»„ä»¶ï¼ˆä½¿ç”¨ImageBuilderçš„é…ç½®å‘½ä»¤ï¼‰
        make defconfig  # å…ˆåŠ è½½é»˜è®¤é…ç½®
        echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
        echo "CONFIG_PACKAGE_oaf=y" >> .config
        echo "CONFIG_PACKAGE_open-app-filter=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-oaf-zh-cn=y" >> .config
        
        # é…ç½®è¾“å‡ºæ ¼å¼
        sed -i '/CONFIG_TARGET_ROOTFS_TARGZ/d' .config
        sed -i '/CONFIG_TARGET_ROOTFS_SQUASHFS/d' .config
        echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
        echo "# CONFIG_TARGET_ROOTFS_SQUASHFS is not set" >> .config
        
        # é…ç½®Docker
        if [ "${{ inputs.include_docker }}" = "yes" ]; then
          echo "CONFIG_PACKAGE_docker=y" >> .config
          echo "CONFIG_PACKAGE_docker-compose=y" >> .config
        fi
        
        # åº”ç”¨é…ç½®
        make defconfig

    - name: ğŸ› ï¸ ä¿®æ­£build24.shç¡®ä¿OAFè¢«åŒ…å«
      run: |
        # æ¸…ç†æ—§é…ç½®
        sed -i '/oaf/d' imagebuilder/build24.sh
        sed -i '/open-app-filter/d' imagebuilder/build24.sh
        
        # æ˜ç¡®æ·»åŠ OAFç»„ä»¶åˆ°PACKAGES
        echo 'PACKAGES="$PACKAGES luci-app-oaf"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES oaf"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES open-app-filter"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES luci-i18n-oaf-zh-cn"' >> imagebuilder/build24.sh
        
        # æ·»åŠ Dockerï¼ˆå¦‚æœéœ€è¦ï¼‰
        if [ "${{ inputs.include_docker }}" = "yes" ]; then
          echo 'PACKAGES="$PACKAGES docker docker-compose"' >> imagebuilder/build24.sh
        fi

    - name: ğŸ§± ç¼–è¯‘OAFç»„ä»¶ï¼ˆä½¿ç”¨OpenWrtæ ‡å‡†å‘½ä»¤ï¼‰
      working-directory: ./imagebuilder
      run: |
        # å…³é”®ï¼šå…ˆæ›´æ–°packageç´¢å¼•
        make package/update V=s
        
        # ç¼–è¯‘luci-app-oafï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
        echo "=== ç¼–è¯‘luci-app-oaf ==="
        if ! make package/luci-app-oaf/compile V=s; then
          echo "é”™è¯¯ï¼šluci-app-oafç¼–è¯‘å¤±è´¥ï¼ŒæŸ¥çœ‹ä»¥ä¸‹æ—¥å¿—ï¼š"
          cat build_dir/target-aarch64_generic_musl/luci-app-oaf/compile.log 2>/dev/null
          exit 1
        fi
        
        # ç¼–è¯‘oafå†…æ ¸æ¨¡å—
        echo "=== ç¼–è¯‘oafå†…æ ¸æ¨¡å— ==="
        if ! make package/oaf/compile V=s; then
          echo "é”™è¯¯ï¼šoafå†…æ ¸æ¨¡å—ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        # ç¼–è¯‘open-app-filteræœåŠ¡
        echo "=== ç¼–è¯‘open-app-filteræœåŠ¡ ==="
        if ! make package/open-app-filter/compile V=s; then
          echo "é”™è¯¯ï¼šopen-app-filteræœåŠ¡ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        # éªŒè¯IPKç”Ÿæˆ
        OAF_IPKS=$(find bin/packages/armsr/ -name "oaf*.ipk" -o -name "open-app-filter*.ipk")
        if [ -z "$OAF_IPKS" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°OAFç»„ä»¶çš„IPKæ–‡ä»¶"
          exit 1
        fi
        echo "ç”Ÿæˆçš„OAF IPKæ–‡ä»¶ï¼š"
        echo "$OAF_IPKS"

    - name: ğŸ§± æ„å»ºiStoreOS-rootfs
      working-directory: ./imagebuilder
      run: |
        chmod +x build24.sh
        bash ./build24.sh || {
          echo "é”™è¯¯ï¼šrootfsæ„å»ºå¤±è´¥"
          exit 1
        }
        
        # éªŒè¯rootfs
        ROOTFS=$(find bin/targets/armsr/armv8 -name "*generic-rootfs.tar.gz")
        if [ -z "$ROOTFS" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°rootfsæ–‡ä»¶"
          exit 1
        fi
        echo "ç”Ÿæˆçš„rootfsï¼š$ROOTFS"

    - name: ğŸ“Œ æ”¶é›†OAFç»„ä»¶
      run: |
        mkdir -p openappfilter_ipk/{core,service,web,language}
        find imagebuilder/bin/ -name "oaf_*.ipk" -exec cp {} openappfilter_ipk/core/ \;
        find imagebuilder/bin/ -name "open-app-filter_*.ipk" -exec cp {} openappfilter_ipk/service/ \;
        find imagebuilder/bin/ -name "luci-app-oaf_*.ipk" -exec cp {} openappfilter_ipk/web/ \;
        find imagebuilder/bin/ -name "luci-i18n-oaf-zh-cn*.ipk" -exec cp {} openappfilter_ipk/language/ \;

    - name: ğŸš€ ä¸Šä¼ åˆ°Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-24.10-RELEASE-${{ inputs.network_settings }}-${{ github.run_id }}
        body: |
          ## iStoreOS-24.10 å«OAFé˜²æ²‰è¿·æ’ä»¶
          - ç½‘ç»œæ¨¡å¼ï¼š${{ inputs.network_settings }}
          - ç®¡ç†IPï¼š${{ inputs.network_settings == 'static' && inputs.ipaddr || '192.168.100.1' }}
          - é›†æˆOAFå®Œæ•´ç»„ä»¶
        files: |
          imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz
          openappfilter_ipk/core/*.ipk
          openappfilter_ipk/service/*.ipk
          openappfilter_ipk/web/*.ipk
          openappfilter_ipk/language/*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
