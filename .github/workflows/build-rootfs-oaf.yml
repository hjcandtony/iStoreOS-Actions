name: ğŸ’¿ åŸºäºåŸå§‹ç‰ˆæœ¬çš„OAFç¼–è¯‘å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "ç½‘ç»œé…ç½®"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'ç®¡ç†IPï¼ˆé™æ€æ—¶å¿…å¡«ï¼‰'
        default: '192.168.5.88'
      gateway:
        description: 'ç½‘å…³ï¼ˆé™æ€æ—¶å¿…å¡«ï¼‰'
        default: '192.168.5.1'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl git libssl-dev

    - name: ä¸‹è½½ImageBuilder
      run: |
        # ä½¿ç”¨åŸå§‹å¯ç¼–è¯‘çš„ImageBuilderç‰ˆæœ¬
        curl -L -o imagebuilder.tar.zst "https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
        mkdir -p imagebuilder
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst -C imagebuilder --strip-components=1

    - name: å…‹éš†OAFæºç ï¼ˆåŸå§‹ç›®å½•ç»“æ„ï¼‰
      run: |
        # ä¿æŒåŸå§‹ç›®å½•ç»“æ„ï¼Œä¸ä¿®æ”¹è·¯å¾„
        git clone https://github.com/destan19/OpenAppFilter.git imagebuilder/package/OpenAppFilter

    - name: éªŒè¯OAFç»„ä»¶ç»“æ„ï¼ˆå…³é”®ï¼‰
      run: |
        # ç¡®ä¿åŸå§‹Makefileå­˜åœ¨ä¸”æœªè¢«ç ´å
        if [ ! -f "imagebuilder/package/OpenAppFilter/luci-app-oaf/Makefile" ]; then
          echo "é”™è¯¯ï¼šåŸå§‹luci-app-oafçš„Makefileç¼ºå¤±"
          exit 1
        fi
        # æ£€æŸ¥Makefileä¸­çš„æ ¸å¿ƒç¼–è¯‘è§„åˆ™
        if ! grep -q "define Build/Compile" "imagebuilder/package/OpenAppFilter/luci-app-oaf/Makefile"; then
          echo "é”™è¯¯ï¼šMakefileä¸­ç¼ºå¤±ç¼–è¯‘è§„åˆ™"
          exit 1
        fi

    - name: é…ç½®ç¼–è¯‘é€‰é¡¹ï¼ˆåŸå§‹æ–¹å¼ï¼‰
      run: |
        cd imagebuilder
        # å¯ç”¨OAFç»„ä»¶ï¼ˆåŸå§‹é…ç½®æ–¹å¼ï¼‰
        echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
        echo "CONFIG_PACKAGE_oaf=y" >> .config
        echo "CONFIG_PACKAGE_open-app-filter=y" >> .config
        # é…ç½®è¾“å‡ºæ ¼å¼
        echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config

    - name: ç¼–è¯‘OAFç»„ä»¶ï¼ˆåŸå§‹å‘½ä»¤ï¼‰
      working-directory: ./imagebuilder
      run: |
        # ä½¿ç”¨åŸå§‹ç¼–è¯‘å‘½ä»¤ï¼Œä¸ä¿®æ”¹è·¯å¾„
        make package/luci-app-oaf/compile V=s
        make package/oaf/compile V=s
        make package/open-app-filter/compile V=s

    - name: æ„å»ºrootfs
      working-directory: ./imagebuilder
      run: |
        make image V=s
        # éªŒè¯è¾“å‡º
        find bin/targets/ -name "*rootfs.tar.gz"

    - name: ä¸Šä¼ ç»“æœ
      uses: softprops/action-gh-release@v2
      with:
        tag_name: oaf-original-fix-${{ github.run_id }}
        files: imagebuilder/bin/targets/armsr/armv8/*rootfs.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
