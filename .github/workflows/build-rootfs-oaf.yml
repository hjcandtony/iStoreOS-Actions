name: ðŸ’¿ 1129iStoreOSé›†æˆOAFæ’ä»¶
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "ç½‘ç»œé…ç½®"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'ç®¡ç†IPï¼ˆé™æ€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.88'
      gateway:
        description: 'é»˜è®¤ç½‘å…³ï¼ˆé™æ€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: "é›†æˆDocker"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: å‡†å¤‡åŸºç¡€è„šæœ¬
      run: |
        mkdir -p arm64 shell
        # åˆ›å»ºåŸºç¡€æž„å»ºè„šæœ¬
        cat > arm64/build24.sh << 'EOF'
        #!/bin/bash
        set -e
        # åŸºç¡€åŒ…åˆ—è¡¨
        PACKAGES=""
        # æž„å»ºé•œåƒ
        make image PACKAGES="$PACKAGES"
        EOF
        chmod +x arm64/build24.sh
        
        # åˆ›å»ºè¾…åŠ©è„šæœ¬
        for script in prepare-packages.sh custom-packages.sh; do
          cat > "shell/$script" << 'EOF'
          #!/bin/bash
          exit 0
          EOF
          chmod +x "shell/$script"
        done

    - name: é…ç½®ç½‘ç»œå‚æ•°
      run: |
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        mkdir -p "$(dirname "$CONFIG_PATH")"
        # åˆ›å»ºåŸºç¡€ç½‘ç»œé…ç½®
        cat > "$CONFIG_PATH" << 'EOF'
        #!/bin/sh
        # é…ç½®ç½‘ç»œ
        uci set network.lan.proto=dhcp
        uci commit network
        # ç¡®ä¿OAFå¼€æœºå¯åŠ¨
        [ -x /etc/init.d/oaf ] && /etc/init.d/oaf enable
        EOF
        chmod +x "$CONFIG_PATH"
        
        # åº”ç”¨é™æ€IPé…ç½®
        if [ "${{ inputs.network_settings }}" = "static" ]; then
          sed -i 's/proto=dhcp/proto=static/' "$CONFIG_PATH"
          sed -i "/lan/s/$/\nipaddr=${{ inputs.ipaddr }}\ngateway=${{ inputs.gateway }}/" "$CONFIG_PATH"
        fi

    - name: å®‰è£…ä¾èµ–å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential zstd curl unzip git \
          libssl-dev file rsync tar

    - name: ä¸‹è½½iStoreOS ImageBuilder
      run: |
        # ä¸‹è½½å¹¶è§£åŽ‹ImageBuilder
        IMAGEBUILDER_URL="https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
        curl -L -o imagebuilder.tar.zst "$IMAGEBUILDER_URL"
        
        mkdir -p imagebuilder
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst -C imagebuilder --strip-components=1
        
        # éªŒè¯æ ¸å¿ƒæ–‡ä»¶
        if [ ! -f "imagebuilder/Makefile" ]; then
          echo "é”™è¯¯ï¼šImageBuilderç¼ºå°‘Makefile"
          exit 1
        fi

    - name: èŽ·å–OAFé¢„ç¼–è¯‘åŒ…ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      run: |
        # åˆ›å»ºOAFå­˜å‚¨ç›®å½•
        mkdir -p oaf_ipk
        OAF_VERSION="1.0.2"
        ARCH="aarch64_cortex-a53"  # é€‚é…arm64æž¶æž„
        
        # ä¸‹è½½å››ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ˆä½¿ç”¨ç¨³å®šç‰ˆæœ¬ï¼‰
        components=(
          "oaf_${OAF_VERSION}_${ARCH}.ipk"
          "open-app-filter_${OAF_VERSION}_${ARCH}.ipk"
          "luci-app-oaf_${OAF_VERSION}_all.ipk"
          "luci-i18n-oaf-zh-cn_${OAF_VERSION}_all.ipk"
        )
        
        for pkg in "${components[@]}"; do
          # ä»Žå®˜æ–¹æºä¸‹è½½
          curl -fL "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VERSION}/${pkg}" -o "oaf_ipk/${pkg}" || {
            echo "é”™è¯¯ï¼šä¸‹è½½OAFåŒ… ${pkg} å¤±è´¥"
            exit 1
          }
        done
        
        # éªŒè¯ä¸‹è½½æ–‡ä»¶
        ls -l oaf_ipk/

    - name: é…ç½®ImageBuilderæž„å»ºå‚æ•°
      run: |
        # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ°ImageBuilder
        cp arm64/build24.sh imagebuilder/
        cp shell/*.sh imagebuilder/
        
        # é…ç½®è¾“å‡ºæ ¼å¼
        cd imagebuilder
        echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
        echo "# CONFIG_TARGET_ROOTFS_SQUASHFS is not set" >> .config
        
        # é…ç½®Dockerï¼ˆå¦‚æžœéœ€è¦ï¼‰
        if [ "${{ inputs.include_docker }}" = "yes" ]; then
          echo "CONFIG_PACKAGE_docker=y" >> .config
          echo "CONFIG_PACKAGE_docker-compose=y" >> .config
        fi

    - name: æž„å»ºåŸºç¡€ç³»ç»Ÿé•œåƒ
      working-directory: ./imagebuilder
      run: |
        chmod +x build24.sh
        ./build24.sh || {
          echo "åŸºç¡€é•œåƒæž„å»ºå¤±è´¥"
          exit 1
        }
        
        # æ‰¾åˆ°ç”Ÿæˆçš„rootfs
        ROOTFS=$(find bin/targets/armsr/armv8 -name "*rootfs.tar.gz" | head -n1)
        if [ -z "$ROOTFS" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°rootfsæ–‡ä»¶"
          exit 1
        fi
        echo "åŸºç¡€é•œåƒè·¯å¾„: $ROOTFS"
        # å¤åˆ¶åˆ°å·¥ä½œç›®å½•
        cp "$ROOTFS" ../base_rootfs.tar.gz

    - name: å‘é•œåƒä¸­æ·»åŠ OAFæ’ä»¶ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•å¤„ç†rootfs
        mkdir -p rootfs_mount
        # è§£åŽ‹åŸºç¡€é•œåƒ
        tar -zxf base_rootfs.tar.gz -C rootfs_mount
        
        # å¤åˆ¶OAFåŒ…åˆ°é•œåƒçš„ä¸´æ—¶å®‰è£…ç›®å½•
        mkdir -p rootfs_mount/var/opkg/archives
        cp oaf_ipk/*.ipk rootfs_mount/var/opkg/archives/
        
        # åˆ›å»ºè‡ªåŠ¨å®‰è£…è„šæœ¬
        cat > rootfs_mount/etc/uci-defaults/98-install-oaf << 'EOF'
        #!/bin/sh
        # è‡ªåŠ¨å®‰è£…OAFæ’ä»¶
        opkg update
        opkg install oaf open-app-filter luci-app-oaf luci-i18n-oaf-zh-cn
        # å¯åŠ¨æœåŠ¡
        /etc/init.d/oaf start
        /etc/init.d/uhttpd restart
        EOF
        chmod +x rootfs_mount/etc/uci-defaults/98-install-oaf
        
        # é‡æ–°æ‰“åŒ…rootfs
        tar -zcf final_rootfs.tar.gz -C rootfs_mount .

    - name: éªŒè¯æœ€ç»ˆé•œåƒ
      run: |
        if [ ! -f "final_rootfs.tar.gz" ]; then
          echo "é”™è¯¯ï¼šæœ€ç»ˆé•œåƒæ‰“åŒ…å¤±è´¥"
          exit 1
        fi
        echo "æœ€ç»ˆé•œåƒå¤§å°: $(du -h final_rootfs.tar.gz)"

    - name: ä¸Šä¼ æœ€ç»ˆé•œåƒ
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-OAF-${{ github.run_id }}
        body: |
          ## iStoreOS é›†æˆOAFé˜²æ²‰è¿·æ’ä»¶
          - ç½‘ç»œæ¨¡å¼: ${{ inputs.network_settings }}
          - ç®¡ç†IP: ${{ inputs.network_settings == 'static' && inputs.ipaddr || 'DHCPåˆ†é…' }}
          - å·²é¢„å®‰è£…OAFå…¨å¥—ç»„ä»¶
        files: |
          final_rootfs.tar.gz
          oaf_ipk/*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
