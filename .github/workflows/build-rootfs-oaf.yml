name: ðŸš€ éƒ¨ç½²iStoreOSå«OAFæ’ä»¶ï¼ˆæ— ç¼–è¯‘ï¼‰
on:
  workflow_dispatch:
    inputs:
      network_type:
        description: "ç½‘ç»œè®¾ç½®ç±»åž‹"
        required: true
        default: "dhcp"
        type: choice
        options:
          - dhcp
          - static
      ip_address:
        description: "é™æ€IPåœ°å€"
        default: "192.168.1.100"
      gateway_address:
        description: "ç½‘å…³åœ°å€"
        default: "192.168.1.1"

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: åˆ›å»ºå·¥ä½œç›®å½•
        run: |
          mkdir -p final_output firmware_mod oaf_packages

      - name: ä¸‹è½½iStoreOSæˆå“å›ºä»¶
        run: |
          # ç›´æŽ¥ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘å›ºä»¶ï¼Œå®Œå…¨é¿å…ç¼–è¯‘è¿‡ç¨‹
          wget "https://github.com/istoreos/istoreos/releases/download/v21.02.3/istoreos-armsr-armv8-generic-rootfs.tar.gz" -O firmware_mod/base_firmware.tar.gz
          
          # éªŒè¯å›ºä»¶å®Œæ•´æ€§
          if [ ! -f "firmware_mod/base_firmware.tar.gz" ]; then
            echo "é”™è¯¯ï¼šå®˜æ–¹å›ºä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: èŽ·å–OAFé¢„ç¼–è¯‘å®‰è£…åŒ…
        run: |
          # ä¸‹è½½OAFæ‰€æœ‰å¿…è¦ç»„ä»¶çš„é¢„ç¼–è¯‘IPK
          OAF_VER="1.0.2"
          ARCH="aarch64_cortex-a53"
          
          # æ ¸å¿ƒè¿‡æ»¤æ¨¡å—
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/oaf_${OAF_VER}_${ARCH}.ipk" -P oaf_packages/
          # æœåŠ¡ç¨‹åº
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/open-app-filter_${OAF_VER}_${ARCH}.ipk" -P oaf_packages/
          # Webç®¡ç†ç•Œé¢
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/luci-app-oaf_${OAF_VER}_all.ipk" -P oaf_packages/
          # ä¸­æ–‡è¯­è¨€åŒ…
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/luci-i18n-oaf-zh-cn_${OAF_VER}_all.ipk" -P oaf_packages/
          
          # æ£€æŸ¥æ˜¯å¦ä¸‹è½½é½å…¨
          if [ $(ls oaf_packages/*.ipk | wc -l) -ne 4 ]; then
            echo "é”™è¯¯ï¼šOAFç»„ä»¶ä¸‹è½½ä¸å®Œæ•´"
            exit 1
          fi

      - name: è§£åŽ‹å¹¶ä¿®æ”¹å›ºä»¶
        run: |
          # è§£åŽ‹å®˜æ–¹å›ºä»¶
          mkdir -p firmware_mod/rootfs
          tar -zxf firmware_mod/base_firmware.tar.gz -C firmware_mod/rootfs/
          
          # åˆ›å»ºOAFå®‰è£…ç›®å½•
          mkdir -p firmware_mod/rootfs/opt/oaf
          cp oaf_packages/*.ipk firmware_mod/rootfs/opt/oaf/

      - name: é…ç½®ç½‘ç»œè®¾ç½®
        run: |
          # åˆ›å»ºç½‘ç»œé…ç½®è„šæœ¬
          mkdir -p firmware_mod/rootfs/etc/uci-defaults/
          cat > firmware_mod/rootfs/etc/uci-defaults/99-network-setup << EOF
          #!/bin/sh
          uci set network.lan.proto=${{ inputs.network_type }}
          EOF
          
          # å¦‚æžœæ˜¯é™æ€IPï¼Œæ·»åŠ ç›¸å…³é…ç½®
          if [ "${{ inputs.network_type }}" = "static" ]; then
            cat >> firmware_mod/rootfs/etc/uci-defaults/99-network-setup << EOF
            uci set network.lan.ipaddr=${{ inputs.ip_address }}
            uci set network.lan.gateway=${{ inputs.gateway_address }}
            uci set network.lan.netmask=255.255.255.0
            EOF
          fi
          
          # æäº¤ç½‘ç»œé…ç½®
          cat >> firmware_mod/rootfs/etc/uci-defaults/99-network-setup << EOF
          uci commit network
          /etc/init.d/network restart
          EOF
          
          # è®¾ç½®è„šæœ¬æƒé™
          chmod +x firmware_mod/rootfs/etc/uci-defaults/99-network-setup

      - name: åˆ›å»ºOAFè‡ªåŠ¨å®‰è£…è„šæœ¬
        run: |
          # åˆ›å»ºOAFå®‰è£…è„šæœ¬ï¼Œç³»ç»Ÿé¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
          cat > firmware_mod/rootfs/etc/uci-defaults/98-install-oaf << 'EOF'
          #!/bin/sh
          # ç­‰å¾…ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
          sleep 15
          
          # å®‰è£…OAFç»„ä»¶
          opkg install /opt/oaf/oaf_*.ipk
          opkg install /opt/oaf/open-app-filter_*.ipk
          opkg install /opt/oaf/luci-app-oaf_*.ipk
          opkg install /opt/oaf/luci-i18n-oaf-zh-cn_*.ipk
          
          # å¯åŠ¨OAFæœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯
          /etc/init.d/oaf enable
          /etc/init.d/oaf start
          
          # é‡å¯WebæœåŠ¡ä½¿ç•Œé¢ç”Ÿæ•ˆ
          /etc/init.d/uhttpd restart
          
          # æ¸…ç†å®‰è£…åŒ…
          rm -rf /opt/oaf
          EOF
          
          # è®¾ç½®è„šæœ¬æƒé™
          chmod +x firmware_mod/rootfs/etc/uci-defaults/98-install-oaf

      - name: é‡æ–°æ‰“åŒ…å›ºä»¶
        run: |
          # å°†ä¿®æ”¹åŽçš„æ–‡ä»¶é‡æ–°æ‰“åŒ…æˆrootfs
          cd firmware_mod/rootfs/
          tar -zcf ../../final_output/istoreos-with-oaf.tar.gz .
          
          # éªŒè¯æ‰“åŒ…ç»“æžœ
          if [ ! -f "../final_output/istoreos-with-oaf.tar.gz" ]; then
            echo "é”™è¯¯ï¼šå›ºä»¶æ‰“åŒ…å¤±è´¥"
            exit 1
          fi

      - name: è¾“å‡ºå›ºä»¶ä¿¡æ¯
        run: |
          echo "æœ€ç»ˆå›ºä»¶ä¿¡æ¯ï¼š"
          ls -lh final_output/istoreos-with-oaf.tar.gz

      - name: ä¸Šä¼ æœ€ç»ˆå›ºä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: istoreos-oaf-final-${{ github.run_id }}
          body: |
            ## iStoreOS å·²é›†æˆOAFé˜²æ²‰è¿·æ’ä»¶
            - ç½‘ç»œæ¨¡å¼ï¼š${{ inputs.network_type }}
            - IPåœ°å€ï¼š${{ inputs.network_type == 'static' && inputs.ip_address || 'DHCPè‡ªåŠ¨èŽ·å–' }}
            - ç‰¹ç‚¹ï¼šå®Œå…¨æ— ç¼–è¯‘è¿‡ç¨‹ï¼Œç›´æŽ¥ä½¿ç”¨å®˜æ–¹å›ºä»¶é›†æˆ
          files: final_output/istoreos-with-oaf.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
