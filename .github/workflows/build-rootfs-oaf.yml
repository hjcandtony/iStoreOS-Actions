name: ğŸ’¿ 1126St1_Build-Rootfs-release-oaf
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IPï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.88'
      gateway:
        description: 'è¯·è¾“å…¥é»˜è®¤ç½‘å…³ï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: "æ˜¯å¦é›†æˆDockeræ’ä»¶"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ å‡†å¤‡æ„å»ºè„šæœ¬
      run: |
        mkdir -p arm64
        if [ ! -f "arm64/build24.sh" ]; then
          echo "åˆ›å»ºåŸºç¡€build24.sh"
          cat > arm64/build24.sh << EOF
          #!/bin/bash
          set -e
          PACKAGES=""
          make image PACKAGES="\$PACKAGES"
        EOF
          chmod +x arm64/build24.sh
        fi
        
        mkdir -p shell
        for script in "prepare-packages.sh" "custom-packages.sh"; do
          if [ ! -f "shell/$script" ]; then
            cat > "shell/$script" << EOF
            #!/bin/bash
            exit 0
        EOF
            chmod +x "shell/$script"
          fi
        done

    - name: âš™ï¸ è®¾ç½®IPå’Œç½‘å…³
      run: |
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        mkdir -p "$(dirname "$CONFIG_PATH")"
        if [ ! -f "$CONFIG_PATH" ]; then
          cat > "$CONFIG_PATH" << EOF
          #!/bin/sh
          uci set network.lan.proto=dhcp
          uci commit network
        EOF
          chmod +x "$CONFIG_PATH"
        fi
        
        if [ "${{ inputs.network_settings }}" = "static" ]; then
           sed -i 's/proto=dhcp/proto=static/' "$CONFIG_PATH"
           sed -i "/lan/s/$/ipaddr=${{ inputs.ipaddr }}\n gateway=${{ inputs.gateway }}/" "$CONFIG_PATH"
        fi

    - name: â¬ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libncurses5-dev zstd curl unzip git \
          libssl-dev python3-distutils file rsync

    - name: â¬ ä¸‹è½½iStoreOS ImageBuilder
      run: |
        IMAGEBUILDER_URL="https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
        curl -L -o imagebuilder.tar.zst "$IMAGEBUILDER_URL"
        
        mkdir -p imagebuilder
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst -C imagebuilder --strip-components=1
        
        # ç¡®ä¿æ ¸å¿ƒç›®å½•å­˜åœ¨
        for dir in "package" "bin" "build_dir" "feeds" "target" "scripts"; do
          [ ! -d "imagebuilder/$dir" ] && mkdir -p "imagebuilder/$dir"
        done
        
        [ ! -f "imagebuilder/Makefile" ] && { echo "ImageBuilderç¼ºå¤±Makefile"; exit 1; }

    - name: â¬ è·å–OAFé¢„ç¼–è¯‘IPKï¼ˆå…³é”®ä¿®å¤ï¼‰
      run: |
        # åˆ›å»ºOAF IPKå­˜æ”¾ç›®å½•
        mkdir -p imagebuilder/packages/oaf
        
        # ä¸‹è½½é€‚åˆarmsr-armv8æ¶æ„çš„OAFé¢„ç¼–è¯‘åŒ…
        OAF_ARCH="aarch64_cortex-a53"  # é€‚é…iStoreOS armsr-armv8æ¶æ„
        OAF_VER="1.0.1"
        
        # æ ¸å¿ƒè¿‡æ»¤æ¨¡å—
        curl -L -o "imagebuilder/packages/oaf/oaf_${OAF_VER}_${OAF_ARCH}.ipk" "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/oaf_${OAF_VER}_${OAF_ARCH}.ipk"
        
        # æœåŠ¡ç»„ä»¶
        curl -L -o "imagebuilder/packages/oaf/open-app-filter_${OAF_VER}_${OAF_ARCH}.ipk" "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/open-app-filter_${OAF_VER}_${OAF_ARCH}.ipk"
        
        # Webç•Œé¢
        curl -L -o "imagebuilder/packages/oaf/luci-app-oaf_${OAF_VER}_all.ipk" "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/luci-app-oaf_${OAF_VER}_all.ipk"
        
        # ä¸­æ–‡è¯­è¨€åŒ…
        curl -L -o "imagebuilder/packages/oaf/luci-i18n-oaf-zh-cn_${OAF_VER}_all.ipk" "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VER}/luci-i18n-oaf-zh-cn_${OAF_VER}_all.ipk"
        
        # éªŒè¯ä¸‹è½½ç»“æœ
        for ipk in $(ls imagebuilder/packages/oaf/*.ipk); do
          if [ ! -s "$ipk" ]; then
            echo "é”™è¯¯ï¼šOAF IPKæ–‡ä»¶ $ipk ä¸‹è½½å¤±è´¥"
            exit 1
          fi
        done
        
        # å¤åˆ¶åˆ°ImageBuilderçš„packagesç›®å½•
        cp imagebuilder/packages/oaf/*.ipk imagebuilder/packages/

    - name: â¬ é…ç½®ImageBuilder
      run: |
        # å¤åˆ¶æ„å»ºè„šæœ¬
        cp arm64/build24.sh imagebuilder/
        cp shell/prepare-packages.sh imagebuilder/
        cp shell/custom-packages.sh imagebuilder/
        
        # ç¡®ä¿build24.shå­˜åœ¨
        if [ ! -f "imagebuilder/build24.sh" ]; then
          cat > imagebuilder/build24.sh << EOF
          #!/bin/bash
          set -e
          PACKAGES=""
          make image PACKAGES="\$PACKAGES"
        EOF
          chmod +x imagebuilder/build24.sh
        fi
        
        # é…ç½®ç³»ç»Ÿæ–‡ä»¶
        mkdir -p imagebuilder/files/etc/{uci-defaults,opkg}
        cp files/etc/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        [ -f "files/etc/opkg/distfeeds.conf" ] && cp files/etc/opkg/distfeeds.conf imagebuilder/files/etc/opkg/
        
        # é…ç½®è¾“å‡ºæ ¼å¼
        cd imagebuilder
        echo "CONFIG_TARGET_ROOTFS_TARGZ=y" >> .config
        echo "# CONFIG_TARGET_ROOTFS_SQUASHFS is not set" >> .config

    - name: ğŸ› ï¸ é…ç½®build24.shé›†æˆOAF
      run: |
        # æ¸…ç†æ—§é…ç½®
        sed -i '/oaf/d' imagebuilder/build24.sh
        sed -i '/open-app-filter/d' imagebuilder/build24.sh
        sed -i '/docker/d' imagebuilder/build24.sh
        
        # æ·»åŠ OAFç»„ä»¶ï¼ˆç›´æ¥å¼•ç”¨IPKåŒ…åï¼‰
        echo 'PACKAGES="$PACKAGES oaf"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES open-app-filter"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES luci-app-oaf"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES luci-i18n-oaf-zh-cn"' >> imagebuilder/build24.sh
        
        # æ·»åŠ Docker
        if [ "${{ inputs.include_docker }}" = "yes" ]; then
          echo 'PACKAGES="$PACKAGES docker docker-compose"' >> imagebuilder/build24.sh
        fi

    - name: ğŸ§± æ„å»ºiStoreOS-rootfsï¼ˆå«OAFï¼‰
      working-directory: ./imagebuilder
      run: |
        # æ›´æ–°åŒ…åˆ—è¡¨
        ./scripts/feeds update -a 2>/dev/null || true
        ./scripts/feeds install -a 2>/dev/null || true
        
        # æ‰§è¡Œæ„å»º
        chmod +x build24.sh
        bash ./build24.sh || {
          echo "æ„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          cat build_dir/target-aarch64_generic_musl/build.log 2>/dev/null
          exit 1
        }
        
        # éªŒè¯ç»“æœ
        ROOTFS=$(find bin/targets/armsr/armv8 -name "*generic-rootfs.tar.gz")
        if [ -z "$ROOTFS" ]; then
          echo "æœªæ‰¾åˆ°ç”Ÿæˆçš„rootfsæ–‡ä»¶"
          exit 1
        fi
        echo "ç”Ÿæˆçš„rootfs: $ROOTFS"

    - name: ğŸ“Œ æ”¶é›†è¾“å‡ºæ–‡ä»¶
      run: |
        mkdir -p release
        cp imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz release/
        cp imagebuilder/packages/oaf/*.ipk release/

    - name: ğŸš€ ä¸Šä¼ åˆ°Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-24.10-RELEASE-${{ inputs.network_settings }}-${{ github.run_id }}
        body: |
          ## iStoreOS-24.10 å«OAFé˜²æ²‰è¿·æ’ä»¶
          - ç½‘ç»œæ¨¡å¼ï¼š${{ inputs.network_settings }}
          - ç®¡ç†IPï¼š${{ inputs.network_settings == 'static' && inputs.ipaddr || '192.168.100.1' }}
          - å·²é›†æˆOAFé¢„ç¼–è¯‘ç»„ä»¶
        files: |
          release/*.tar.gz
          release/*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
