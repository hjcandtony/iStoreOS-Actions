name: ğŸ”¨ ç¼–è¯‘OpenAppFilteræ’ä»¶(x86/å†…æ ¸6.6)
on:
  workflow_dispatch:

jobs:
  build-oaf:
    runs-on: ubuntu-22.04
    steps:
      - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential subversion libncurses5-dev zlib1g-dev \
            gawk gcc-multilib flex git gettext libssl-dev \
            unzip python3 python3-distutils python3-setuptools

      - name: è·å–OpenWrt x86 6.6å†…æ ¸æºç 
        run: |
          # å…‹éš†OpenWrtæºç ï¼Œåˆ‡æ¢åˆ°6.6å†…æ ¸åˆ†æ”¯
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          
          # åˆ‡æ¢åˆ°æ”¯æŒ6.6å†…æ ¸çš„ç‰ˆæœ¬
          git checkout openwrt-23.05
          
          # æ›´æ–°å¹¶å®‰è£…feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # é…ç½®x86æ¶æ„å’Œ6.6å†…æ ¸
          echo "CONFIG_TARGET_x86=y" > .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
          echo "CONFIG_KERNEL_VERSION=6.6" >> .config
          
          # ç”Ÿæˆåˆæ­¥é…ç½®
          make defconfig

      - name: ä¸‹è½½OpenAppFilteræºç 
        run: |
          # æŒ‰ç…§å®˜æ–¹æ•™ç¨‹å…‹éš†åˆ°packageç›®å½•
          cd openwrt
          git clone https://github.com/destan19/OpenAppFilter.git package/OpenAppFilter

      - name: å¼€å¯OpenAppFilterç¼–è¯‘é€‰é¡¹
        run: |
          cd openwrt
          # æŒ‰ç…§å®˜æ–¹æ•™ç¨‹å¼€å¯ä¸‰ä¸ªæ¨¡å—çš„ç¼–è¯‘é€‰é¡¹
          echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
          make defconfig  # è‡ªåŠ¨å¼€å¯ä¾èµ–çš„å…¶ä»–ä¸¤ä¸ªæ¨¡å—

      - name: ç¼–è¯‘OpenAppFilteræ’ä»¶
        run: |
          cd openwrt
          # ä»…ç¼–è¯‘OpenAppFilterç›¸å…³ç»„ä»¶ï¼Œä¸é‡æ–°ç¼–è¯‘æ•´ä¸ªå›ºä»¶
          make package/luci-app-oaf/compile V=s
          make package/open-app-filter/compile V=s
          make package/oaf/compile V=s

      - name: éªŒè¯ç¼–è¯‘ç»“æœ
        run: |
          # æ£€æŸ¥IPKæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          cd openwrt
          find bin/packages/ -name "oaf*.ipk" -o -name "open-app-filter*.ipk"
          
          # ç¡®è®¤æ‰€æœ‰å¿…è¦ç»„ä»¶éƒ½å·²ç¼–è¯‘
          OAF_IPK_COUNT=$(find bin/packages/ -name "oaf*.ipk" -o -name "open-app-filter*.ipk" | wc -l)
          if [ $OAF_IPK_COUNT -ne 4 ]; then
            echo "é”™è¯¯ï¼šOpenAppFilterç»„ä»¶ç¼–è¯‘ä¸å®Œæ•´"
            exit 1
          fi

      - name: æ”¶é›†ç¼–è¯‘äº§ç‰©
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•å¹¶å¤åˆ¶IPKæ–‡ä»¶
          mkdir -p oaf-output
          cd openwrt
          find bin/packages/ -name "oaf*.ipk" -o -name "open-app-filter*.ipk" -exec cp {} ../oaf-output/ \;
          cd ..
          ls -l oaf-output/

      - name: ä¸Šä¼ ç¼–è¯‘ç»“æœ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: openappfilter-x86-6.6-${{ github.run_id }}
          name: OpenAppFilter for x86 (Kernel 6.6)
          body: |
            OpenAppFilteræ’ä»¶ç¼–è¯‘äº§ç‰©
            - æ¶æ„: x86_64
            - å†…æ ¸ç‰ˆæœ¬: 6.6
            - åŒ…å«ç»„ä»¶: luci-app-oaf, oaf, open-app-filteråŠå…¶è¯­è¨€åŒ…
          files: oaf-output/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
