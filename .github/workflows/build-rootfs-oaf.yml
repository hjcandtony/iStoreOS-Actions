name: 🔨 编译OpenAppFilter插件(x86/内核6.6)
on:
  workflow_dispatch:

jobs:
  build-oaf:
    runs-on: ubuntu-22.04
    steps:
      - name: 准备编译环境
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential subversion libncurses5-dev zlib1g-dev \
            gawk gcc-multilib flex git gettext libssl-dev \
            unzip python3 python3-distutils python3-setuptools

      - name: 获取OpenWrt x86 6.6内核源码
        run: |
          # 克隆OpenWrt源码，切换到6.6内核分支
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          
          # 切换到支持6.6内核的版本
          git checkout openwrt-23.05
          
          # 更新并安装feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # 配置x86架构和6.6内核
          echo "CONFIG_TARGET_x86=y" > .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
          echo "CONFIG_KERNEL_VERSION=6.6" >> .config
          
          # 生成初步配置
          make defconfig

      - name: 下载OpenAppFilter源码
        run: |
          # 按照官方教程克隆到package目录
          cd openwrt
          git clone https://github.com/destan19/OpenAppFilter.git package/OpenAppFilter

      - name: 开启OpenAppFilter编译选项
        run: |
          cd openwrt
          # 按照官方教程开启三个模块的编译选项
          echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
          make defconfig  # 自动开启依赖的其他两个模块

      - name: 编译OpenAppFilter插件
        run: |
          cd openwrt
          # 仅编译OpenAppFilter相关组件，不重新编译整个固件
          make package/luci-app-oaf/compile V=s
          make package/open-app-filter/compile V=s
          make package/oaf/compile V=s

      - name: 验证编译结果
        run: |
          # 检查IPK文件是否生成
          cd openwrt
          find bin/packages/ -name "oaf*.ipk" -o -name "open-app-filter*.ipk"
          
          # 确认所有必要组件都已编译
          OAF_IPK_COUNT=$(find bin/packages/ -name "oaf*.ipk" -o -name "open-app-filter*.ipk" | wc -l)
          if [ $OAF_IPK_COUNT -ne 4 ]; then
            echo "错误：OpenAppFilter组件编译不完整"
            exit 1
          fi

      - name: 收集编译产物
        run: |
          # 创建输出目录并复制IPK文件
          mkdir -p oaf-output
          cd openwrt
          find bin/packages/ -name "oaf*.ipk" -o -name "open-app-filter*.ipk" -exec cp {} ../oaf-output/ \;
          cd ..
          ls -l oaf-output/

      - name: 上传编译结果
        uses: softprops/action-gh-release@v2
        with:
          tag_name: openappfilter-x86-6.6-${{ github.run_id }}
          name: OpenAppFilter for x86 (Kernel 6.6)
          body: |
            OpenAppFilter插件编译产物
            - 架构: x86_64
            - 内核版本: 6.6
            - 包含组件: luci-app-oaf, oaf, open-app-filter及其语言包
          files: oaf-output/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
