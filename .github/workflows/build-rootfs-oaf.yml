name: ğŸ’¿ St1_Build-Rootfs-release-oaf
on:
  workflow_dispatch:
    inputs:
      network_settings:
        description: "è¯·é€‰æ‹©åˆå§‹ç½‘ç»œé…ç½®"
        required: true
        default: 'dhcp'
        type: choice
        options:
          - 'static'
          - 'dhcp'
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IPï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.88'
      gateway:
        description: 'è¯·è¾“å…¥é»˜è®¤ç½‘å…³ï¼ˆé™æ€åœ°å€æ—¶å¿…å¡«ï¼‰'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: "æ˜¯å¦é›†æˆDockeræ’ä»¶"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
      run: | 
        chmod +x arm64/build24.sh
        chmod +x shell/*.sh

    - name: âš™ï¸ è®¾ç½®IPå’Œç½‘å…³
      run: |
        CONFIG_PATH="./files/etc/uci-defaults/99-custom.sh"
        echo "å½“å‰ç½‘ç»œé…ç½®è·¯å¾„ï¼š$CONFIG_PATH"
        # ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨ï¼ˆé¿å…åç»­ä¿®æ”¹æŠ¥é”™ï¼‰
        if [ ! -f "$CONFIG_PATH" ]; then
          echo "é”™è¯¯ï¼šç½‘ç»œé…ç½®æ–‡ä»¶ $CONFIG_PATH ä¸å­˜åœ¨"
          exit 1
        fi
        # æ ¹æ®é€‰æ‹©çš„ç½‘ç»œæ¨¡å¼ä¿®æ”¹é…ç½®
        if [ "${{ inputs.network_settings }}" = "static" ]; then
           echo "åˆ é™¤DHCPé…ç½®ï¼Œä¿ç•™é™æ€é…ç½®"
           sed -i '44,105d' "$CONFIG_PATH"
           sed -i "/ipaddr/s/192.168.5.88/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"
           sed -i "/gateway/s/192.168.5.1/${{ inputs.gateway }}/g" "$CONFIG_PATH"
        else
           echo "åˆ é™¤é™æ€é…ç½®ï¼Œä¿ç•™DHCPé…ç½®"
           sed -i '36,42d' "$CONFIG_PATH"
        fi
        # è¾“å‡ºæœ€ç»ˆé…ç½®ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
        echo "æœ€ç»ˆç½‘ç»œé…ç½®ï¼š"
        cat "$CONFIG_PATH"

    - name: â¬ å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆé€‚é…ImageBuilder+OAFç¼–è¯‘ï¼‰
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libncurses5-dev zstd curl unzip tree git \
          libssl-dev python3-distutils libgmp3-dev libmpc-dev  # è¡¥å……OAFç¼–è¯‘å¿…éœ€çš„åº•å±‚ä¾èµ–

    - name: â¬ ä¸‹è½½å¹¶éªŒè¯iStoreOS ImageBuilder
      run: |
        # ä¸‹è½½ImageBuilderï¼ˆä½¿ç”¨æ–‡æ¡£ç¡®è®¤çš„æœ‰æ•ˆé“¾æ¥ï¼‰
        IMAGEBUILDER_URL="https://github.com/Kwonelee/iStoreOS-Actions/releases/download/iStoreOS-ImageBuilder-20250905/istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
        curl -L -o imagebuilder.tar.zst "$IMAGEBUILDER_URL"
        # éªŒè¯å‹ç¼©åŒ…å®Œæ•´æ€§ï¼ˆé¿å…ä¸‹è½½æŸåå¯¼è‡´åç»­æŠ¥é”™ï¼‰
        echo "éªŒè¯ImageBuilderå‹ç¼©åŒ…..."
        if ! tar --use-compress-program=unzstd -tf imagebuilder.tar.zst > /dev/null; then
          echo "é”™è¯¯ï¼šImageBuilderå‹ç¼©åŒ…æŸåï¼Œé‡æ–°ä¸‹è½½"
          exit 1
        fi
        # è§£å‹å¹¶é‡å‘½åï¼ˆç»Ÿä¸€ç›®å½•åï¼Œé¿å…è·¯å¾„å«ç‰¹æ®Šå­—ç¬¦ï¼‰
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv istoreos-imagebuilder-* imagebuilder
        # ç¡®è®¤ImageBuilderæ ¸å¿ƒæ–‡ä»¶å­˜åœ¨ï¼ˆåŸºç¡€æ ¡éªŒï¼‰
        if [ ! -f "imagebuilder/Makefile" ] || [ ! -d "imagebuilder/package" ] || [ ! -d "imagebuilder/bin" ]; then
          echo "é”™è¯¯ï¼šImageBuilderè§£å‹ä¸å®Œæ•´ï¼Œç¼ºå°‘æ ¸å¿ƒæ–‡ä»¶ï¼ˆMakefile/package/binï¼‰"
          exit 1
        fi
        echo "ImageBuilderä¸‹è½½è§£å‹å®Œæˆï¼Œç›®å½•ç»“æ„ï¼š"
        tree -L 1 imagebuilder/

    - name: â¬ å…‹éš†OpenAppFilteræºç ï¼ˆé€‚é…ImageBuilderè·¯å¾„ï¼‰
      run: |
        # å…³é”®ï¼šImageBuilderçš„packageç›®å½•ç›´æ¥å­˜æ”¾ç¬¬ä¸‰æ–¹åŒ…ï¼Œæ— éœ€é¢å¤–åµŒå¥—
        git clone https://github.com/destan19/OpenAppFilter.git imagebuilder/package/OpenAppFilter
        # éªŒè¯OAFä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆé¿å…å…‹éš†å¤±è´¥å¯¼è‡´åç»­ç¼–è¯‘ç©ºè½¬ï¼‰
        OAF_REQUIRED_DIRS=("imagebuilder/package/OpenAppFilter/luci-app-oaf" "imagebuilder/package/OpenAppFilter/oaf" "imagebuilder/package/OpenAppFilter/open-app-filter")
        for dir in "${OAF_REQUIRED_DIRS[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "é”™è¯¯ï¼šOAFæ ¸å¿ƒç»„ä»¶ç›®å½• $dir ç¼ºå¤±ï¼Œå…‹éš†å¤±è´¥"
            exit 1
          fi
        done
        echo "OAFæºç å…‹éš†å®Œæˆï¼Œæ ¸å¿ƒç»„ä»¶ç›®å½•ï¼š"
        ls -l imagebuilder/package/OpenAppFilter/

    - name: â¬ å¤åˆ¶å¿…å¤‡æ–‡ä»¶å¹¶é…ç½®ImageBuilder
      run: |
        # å¤åˆ¶è‡ªå®šä¹‰æ„å»ºè„šæœ¬
        cp arm64/{build24.sh,Makefile} imagebuilder/
        cp shell/{prepare-packages.sh,custom-packages.sh} imagebuilder/
        # å¤åˆ¶é¢„ç¼–è¯‘IPKåŒ…ï¼ˆè‹¥æœ‰ï¼‰
        find files/packages/ -name "*.ipk" -exec cp {} imagebuilder/packages/ \;
        
        # åˆ›å»ºç³»ç»Ÿé…ç½®ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
        mkdir -p imagebuilder/files/etc/{uci-defaults,opkg,banner1,openclash/core}
        cp files/etc/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        cp files/etc/opkg/distfeeds.conf imagebuilder/files/etc/opkg/
        cp files/etc/banner imagebuilder/files/etc/banner1/
        cp files/etc/openclash/core/clash_meta imagebuilder/files/etc/openclash/core/
        cp files/etc/rc.local imagebuilder/files/etc/
        
        # é…ç½®ImageBuilderè¾“å‡ºæ ¼å¼ï¼ˆå¯ç”¨rootfs.tar.gzï¼Œç¦ç”¨ä¸éœ€è¦çš„SQUASHFS/GZIPï¼‰
        cd imagebuilder
        sed -i 's/# CONFIG_TARGET_ROOTFS_TARGZ is not set/CONFIG_TARGET_ROOTFS_TARGZ=y/' .config
        sed -i "s|CONFIG_TARGET_ROOTFS_SQUASHFS=.*|# CONFIG_TARGET_ROOTFS_SQUASHFS is not set|g" .config
        sed -i "s|CONFIG_TARGET_IMAGES_GZIP=.*|# CONFIG_TARGET_IMAGES_GZIP is not set|g" .config
        
        # å…³é”®ï¼šç›´æ¥å†™.configå¯ç”¨OAFï¼ˆImageBuilderä¼šè‡ªåŠ¨å¤„ç†ä¾èµ–ï¼Œæ— éœ€defconfigï¼‰
        echo "å¯ç”¨OAFä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶åŠä¸­æ–‡è¯­è¨€åŒ…"
        echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config          # OAF Webç•Œé¢ï¼ˆå¿…é€‰ï¼‰
        echo "CONFIG_PACKAGE_oaf=y" >> .config                # OAFå†…æ ¸æ¨¡å—ï¼ˆå¿…é€‰ï¼‰
        echo "CONFIG_PACKAGE_open-app-filter=y" >> .config    # OAFæœåŠ¡æ ¸å¿ƒï¼ˆå¿…é€‰ï¼‰
        echo "CONFIG_PACKAGE_luci-i18n-oaf-zh-cn=y" >> .config# OAFä¸­æ–‡è¯­è¨€åŒ…ï¼ˆå¯é€‰ï¼Œæå‡æ˜“ç”¨æ€§ï¼‰
        
        # è‹¥éœ€è¦é›†æˆDockerï¼Œæ·»åŠ Dockerç›¸å…³é…ç½®ï¼ˆæ ¹æ®è¾“å…¥å‚æ•°ï¼‰
        if [ "${{ inputs.include_docker }}" = "yes" ]; then
          echo "å¯ç”¨Dockerç›¸å…³ç»„ä»¶é…ç½®"
          echo "CONFIG_PACKAGE_docker=y" >> .config
          echo "CONFIG_PACKAGE_docker-compose=y" >> .config
        fi

    - name: ğŸ› ï¸ ä¿®æ”¹build24.shï¼ˆç¡®ä¿OAFè¢«çº³å…¥æ„å»ºï¼‰
      run: |
        # è§£é™¤åŸæœ‰OAFç›¸å…³åŒ…çš„æ³¨é‡Šï¼ˆè‹¥è„šæœ¬ä¸­å­˜åœ¨æ³¨é‡Šçš„OAFé…ç½®ï¼‰
        sed -i 's/#PACKAGES="$PACKAGES luci-i18n-oaf-zh-cn"/PACKAGES="$PACKAGES luci-i18n-oaf-zh-cn"/g' imagebuilder/build24.sh
        sed -i 's/#PACKAGES="$PACKAGES luci-app-oaf"/PACKAGES="$PACKAGES luci-app-oaf"/g' imagebuilder/build24.sh
        # è¡¥å……OAFæ ¸å¿ƒç»„ä»¶ï¼ˆé¿å…build24.shé—æ¼ï¼Œç¡®ä¿ç¼–è¯‘æ—¶è¢«åŒ…å«ï¼‰
        echo 'PACKAGES="$PACKAGES oaf"' >> imagebuilder/build24.sh
        echo 'PACKAGES="$PACKAGES open-app-filter"' >> imagebuilder/build24.sh
        # è‹¥é›†æˆDockerï¼Œæ·»åŠ Dockeråˆ°PACKAGES
        if [ "${{ inputs.include_docker }}" = "yes" ]; then
          echo 'PACKAGES="$PACKAGES docker docker-compose"' >> imagebuilder/build24.sh
        fi
        # éªŒè¯ä¿®æ”¹ç»“æœ
        echo "build24.shä¸­OAFç›¸å…³é…ç½®ï¼š"
        grep -E "oaf|open-app-filter" imagebuilder/build24.sh

    - name: ğŸ§± å•ç‹¬ç¼–è¯‘OAFä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ˆImageBuilderé€‚é…å‘½ä»¤ï¼‰
      working-directory: ./imagebuilder
      run: |
        # å…³é”®ï¼šImageBuilderç¼–è¯‘ç¬¬ä¸‰æ–¹åŒ…çš„æ­£ç¡®å‘½ä»¤ï¼ˆæŒ‡å®šå®Œæ•´è·¯å¾„ï¼ŒV=sæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•ï¼‰
        echo "å¼€å§‹ç¼–è¯‘OAF Webç•Œé¢ç»„ä»¶ï¼ˆluci-app-oafï¼‰"
        make package/OpenAppFilter/luci-app-oaf/compile V=s
        echo "å¼€å§‹ç¼–è¯‘OAFå†…æ ¸æ¨¡å—ï¼ˆoafï¼‰"
        make package/OpenAppFilter/oaf/compile V=s
        echo "å¼€å§‹ç¼–è¯‘OAFæœåŠ¡æ ¸å¿ƒï¼ˆopen-app-filterï¼‰"
        make package/OpenAppFilter/open-app-filter/compile V=s
        
        # æ ¡éªŒOAFç»„ä»¶æ˜¯å¦ç¼–è¯‘æˆåŠŸï¼ˆç”ŸæˆIPKæ–‡ä»¶ï¼‰
        OAF_IPK_PATHS=("bin/packages/armsr/base/oaf_*.ipk" "bin/packages/armsr/base/open-app-filter_*.ipk" "bin/packages/armsr/luci/luci-app-oaf_*.ipk")
        for ipk_path in "${OAF_IPK_PATHS[@]}"; do
          if ! ls $ipk_path 2>/dev/null; then
            echo "é”™è¯¯ï¼šOAFç»„ä»¶ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ° $ipk_path"
            exit 1
          fi
        done
        echo "OAFä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ç¼–è¯‘å®Œæˆï¼ŒIPKæ–‡ä»¶ï¼š"
        ls -l bin/packages/armsr/{base,luci}/oaf*.ipk

    - name: ğŸ§± æ„å»ºiStoreOS-rootfsï¼ˆé›†æˆOAFï¼‰
      working-directory: ./imagebuilder
      run: |
        echo "ImageBuilderæ„å»ºç›®å½•ç»“æ„ï¼š"
        tree -L 2 bin/ packages/
        echo "æ‰§è¡Œè‡ªå®šä¹‰æ„å»ºè„šæœ¬ build24.sh"
        bash ./build24.sh
        
        # æ ¡éªŒrootfsæ˜¯å¦ç”ŸæˆæˆåŠŸ
        ROOTFS_FILE="bin/targets/armsr/armv8/*generic-rootfs.tar.gz"
        if [ ! -f $ROOTFS_FILE ]; then
          echo "é”™è¯¯ï¼šrootfsæ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ° $ROOTFS_FILE"
          exit 1
        fi
        echo "rootfsæ„å»ºå®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
        ls -lah $ROOTFS_FILE

    - name: ğŸ“Œ åˆ†ç±»æ”¶é›†OAFç»„ä»¶IPKï¼ˆä¾¿äºå•ç‹¬ä¸Šä¼ ï¼‰
      id: collect_ipks
      run: |
        # åˆ›å»ºåˆ†ç±»ç›®å½•ï¼ˆæ˜ç¡®åŒºåˆ†ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œé¿å…æ··æ·†ï¼‰
        mkdir -p openappfilter_ipk/{oaf-core, oaf-service, oaf-web, oaf-language}
        # æ”¶é›†OAFæ ¸å¿ƒç»„ä»¶ï¼ˆæŒ‰åŠŸèƒ½åˆ†ç±»ï¼‰
        find imagebuilder/bin/packages/ -name "oaf_*.ipk" -exec cp {} openappfilter_ipk/oaf-core/ \; -print
        find imagebuilder/bin/packages/ -name "open-app-filter_*.ipk" -exec cp {} openappfilter_ipk/oaf-service/ \; -print
        find imagebuilder/bin/packages/ -name "luci-app-oaf_*.ipk" -exec cp {} openappfilter_ipk/oaf-web/ \; -print
        find imagebuilder/bin/packages/ -name "luci-i18n-oaf-zh-cn*.ipk" -exec cp {} openappfilter_ipk/oaf-language/ \; -print
        
        # æ ¡éªŒæ”¶é›†ç»“æœ
        echo "OAFç»„ä»¶æ”¶é›†å®Œæˆï¼Œç›®å½•ç»“æ„ï¼š"
        tree openappfilter_ipk/
        # ç»Ÿè®¡IPKæ–‡ä»¶æ•°é‡ï¼ˆç¡®ä¿æ— é—æ¼ï¼‰
        IPK_COUNT=$(find openappfilter_ipk/ -name "*.ipk" | wc -l)
        echo "å…±æ”¶é›†åˆ° $IPK_COUNT ä¸ªOAFç›¸å…³IPKæ–‡ä»¶"
        if [ $IPK_COUNT -lt 3 ]; then
          echo "è­¦å‘Šï¼šOAFç»„ä»¶æ”¶é›†æ•°é‡ä¸è¶³ï¼ˆé¢„æœŸâ‰¥3ä¸ªï¼‰ï¼Œå¯èƒ½å­˜åœ¨é—æ¼"
        fi

    - name: ğŸ“¦ éªŒè¯æœ€ç»ˆè¾“å‡ºæ–‡ä»¶
      run: |
        echo "=== æœ€ç»ˆè¾“å‡ºæ–‡ä»¶æ ¡éªŒ ==="
        echo "1. Rootfsæ–‡ä»¶ï¼š"
        ls -lah imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz
        echo "2. OAFç»„ä»¶æ–‡ä»¶ï¼š"
        du -sh openappfilter_ipk/*/*.ipk

    - name: ğŸš€ ä¸Šä¼ åˆ°Releaseï¼ˆå«Rootfs+å®Œæ•´OAFç»„ä»¶ï¼‰
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-24.10-RELEASE-${{ inputs.network_settings }}-${{ github.run_id }}
        # æ·»åŠ å”¯ä¸€run_idé¿å…æ ‡ç­¾é‡å¤æŠ¥é”™
        name: iStoreOS-24.10ï¼ˆå«OAFé˜²æ²‰è¿·æ’ä»¶ï¼‰-${{ inputs.network_settings }}
        body: |
          ## ğŸ“Œ ç‰ˆæœ¬ä¿¡æ¯
          - ç³»ç»Ÿç‰ˆæœ¬ï¼šiStoreOS-24.10.2-RELEASE
          - æ¶æ„ï¼šarmsr-armv8ï¼ˆé€‚ç”¨äºARM64æ¶æ„è®¾å¤‡ï¼‰
          - ç½‘ç»œæ¨¡å¼ï¼š${{ inputs.network_settings }}
          - ç®¡ç†IPï¼š${{ inputs.network_settings == 'static' && inputs.ipaddr || 'å•ç½‘å£-åŠ¨æ€è·å–ï¼›å¤šç½‘å£-192.168.100.1' }}
          - Dockeré›†æˆï¼š${{ inputs.include_docker == 'yes' && 'å·²é›†æˆ' || 'æœªé›†æˆ' }}

          ## ğŸ§© æ ¸å¿ƒé›†æˆç»„ä»¶
          ### OpenAppFilteré˜²æ²‰è¿·æ’ä»¶ï¼ˆå®Œæ•´ä¸‰ä»¶å¥—ï¼‰
          1. **oaf-core**ï¼šOAFå†…æ ¸æ¨¡å—ï¼ˆå¿…è£…ï¼Œå®ç°è¿‡æ»¤åŠŸèƒ½åº•å±‚æ”¯æŒï¼‰
          2. **oaf-service**ï¼šOAFæœåŠ¡æ ¸å¿ƒï¼ˆå¿…è£…ï¼Œç®¡ç†è¿‡æ»¤è§„åˆ™ä¸è¿›ç¨‹ï¼‰
          3. **oaf-web**ï¼šOAF Webç•Œé¢ï¼ˆå¿…è£…ï¼ŒLuCIå¯è§†åŒ–æ“ä½œé¢æ¿ï¼‰
          4. **oaf-language**ï¼šOAFä¸­æ–‡è¯­è¨€åŒ…ï¼ˆå¯é€‰ï¼Œä¼˜åŒ–ä¸­æ–‡æ˜¾ç¤ºï¼‰

          ## ğŸ”‘ ç™»å½•ä¿¡æ¯
          - ç”¨æˆ·åï¼šroot
          - å¯†ç ï¼šæ— ï¼ˆé¦–æ¬¡ç™»å½•æ— éœ€å¯†ç ï¼Œå»ºè®®ç«‹å³è®¾ç½®ï¼‰

          ## ğŸ“‚ ä¸‹è½½æ–‡ä»¶è¯´æ˜
          - `*generic-rootfs.tar.gz`ï¼šå®Œæ•´ç³»ç»Ÿé•œåƒï¼ˆå·²é›†æˆOAFï¼‰
          - `oaf-core/`ï¼šOAFå†…æ ¸æ¨¡å—IPKï¼ˆå•ç‹¬å®‰è£…ç”¨ï¼‰
          - `oaf-service/`ï¼šOAFæœåŠ¡æ ¸å¿ƒIPKï¼ˆå•ç‹¬å®‰è£…ç”¨ï¼‰
          - `oaf-web/`ï¼šOAF Webç•Œé¢IPKï¼ˆå•ç‹¬å®‰è£…ç”¨ï¼‰
          - `oaf-language/`ï¼šOAFä¸­æ–‡è¯­è¨€åŒ…IPKï¼ˆå•ç‹¬å®‰è£…ç”¨ï¼‰

          ## ğŸ“ ç›¸å…³é“¾æ¥
          - iStoreOS ImageBuilderï¼šhttps://github.com/Kwonelee/iStoreOS-Actions
          - OpenAppFilterå®˜æ–¹ï¼šhttps://github.com/destan19/OpenAppFilter
        files: |
          # ä¸Šä¼ å®Œæ•´ç³»ç»Ÿé•œåƒ
          imagebuilder/bin/targets/armsr/armv8/*generic-rootfs.tar.gz
          # ä¸Šä¼ OAFä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ˆåˆ†ç±»ç›®å½•ï¼‰
          openappfilter_ipk/oaf-core/*.ipk
          openappfilter_ipk/oaf-service/*.ipk
          openappfilter_ipk/oaf-web/*.ipk
          # ä¸Šä¼ OAFä¸­æ–‡è¯­è¨€åŒ…ï¼ˆå¯é€‰ï¼‰
          openappfilter_ipk/oaf-language/*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
