name: ðŸ“¦ 1132iStoreOSé›†æˆOAFï¼ˆæ— ç¼–è¯‘ç‰ˆï¼‰
on:
  workflow_dispatch:
    inputs:
      network_mode:
        description: "ç½‘ç»œæ¨¡å¼"
        required: true
        default: "dhcp"
        type: choice
        options:
          - dhcp
          - static
      static_ip:
        description: "é™æ€IPï¼ˆä»…é™æ€æ¨¡å¼ï¼‰"
        default: "192.168.5.88"
      static_gateway:
        description: "ç½‘å…³ï¼ˆä»…é™æ€æ¨¡å¼ï¼‰"
        default: "192.168.5.1"

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: å‡†å¤‡å·¥ä½œç›®å½•
        run: |
          mkdir -p firmware oaf_files working_dir

      - name: ä¸‹è½½iStoreOSå®˜æ–¹å›ºä»¶
        run: |
          # ä¸‹è½½é€‚åˆarm64çš„å®˜æ–¹å›ºä»¶ï¼ˆé¿å…ç¼–è¯‘ï¼‰
          FIRMWARE_URL="https://github.com/istoreos/istoreos/releases/download/v21.02.3/istoreos-armsr-armv8-generic-rootfs.tar.gz"
          curl -L -o firmware/base_firmware.tar.gz "$FIRMWARE_URL"
          
          # éªŒè¯å›ºä»¶
          if [ ! -s "firmware/base_firmware.tar.gz" ]; then
            echo "é”™è¯¯ï¼šå®˜æ–¹å›ºä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: èŽ·å–OAFé¢„ç¼–è¯‘åŒ…
        run: |
          OAF_VERSION="1.0.2"
          ARCH="aarch64_cortex-a53"
          
          # ä¸‹è½½æ‰€æœ‰å¿…è¦çš„OAFç»„ä»¶
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VERSION}/oaf_${OAF_VERSION}_${ARCH}.ipk" -P oaf_files/
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VERSION}/open-app-filter_${OAF_VERSION}_${ARCH}.ipk" -P oaf_files/
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VERSION}/luci-app-oaf_${OAF_VERSION}_all.ipk" -P oaf_files/
          wget "https://github.com/destan19/OpenAppFilter/releases/download/v${OAF_VERSION}/luci-i18n-oaf-zh-cn_${OAF_VERSION}_all.ipk" -P oaf_files/
          
          # éªŒè¯ä¸‹è½½
          if [ $(ls oaf_files/*.ipk | wc -l) -ne 4 ]; then
            echo "é”™è¯¯ï¼šOAFç»„ä»¶ä¸‹è½½ä¸å®Œæ•´"
            exit 1
          fi

      - name: è§£åŽ‹å®˜æ–¹å›ºä»¶å¹¶ä¿®æ”¹
        run: |
          # è§£åŽ‹å›ºä»¶åˆ°å·¥ä½œç›®å½•
          tar -zxf firmware/base_firmware.tar.gz -C working_dir/
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p working_dir/etc/uci-defaults/
          mkdir -p working_dir/var/opkg/archives/
          
          # å¤åˆ¶OAFåŒ…åˆ°å›ºä»¶ä¸­
          cp oaf_files/*.ipk working_dir/var/opkg/archives/

      - name: é…ç½®ç½‘ç»œï¼ˆé™æ€/DHCPï¼‰
        run: |
          # åˆ›å»ºç½‘ç»œé…ç½®è„šæœ¬
          cat > working_dir/etc/uci-defaults/90-network-config << EOF
          #!/bin/sh
          # ç½‘ç»œé…ç½®
          uci set network.lan.proto=${{ inputs.network_mode }}
          EOF
          
          # å¦‚æžœæ˜¯é™æ€IPï¼Œæ·»åŠ IPå’Œç½‘å…³é…ç½®
          if [ "${{ inputs.network_mode }}" = "static" ]; then
            cat >> working_dir/etc/uci-defaults/90-network-config << EOF
            uci set network.lan.ipaddr=${{ inputs.static_ip }}
            uci set network.lan.gateway=${{ inputs.static_gateway }}
            EOF
          fi
          
          # å®Œæˆç½‘ç»œé…ç½®
          cat >> working_dir/etc/uci-defaults/90-network-config << EOF
          uci commit network
          /etc/init.d/network restart
          EOF
          
          chmod +x working_dir/etc/uci-defaults/90-network-config

      - name: æ·»åŠ OAFè‡ªåŠ¨å®‰è£…è„šæœ¬
        run: |
          # åˆ›å»ºOAFè‡ªåŠ¨å®‰è£…è„šæœ¬
          cat > working_dir/etc/uci-defaults/95-install-oaf << 'EOF'
          #!/bin/sh
          # ç­‰å¾…ç½‘ç»œå°±ç»ª
          sleep 10
          
          # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…OAF
          opkg update
          opkg install /var/opkg/archives/oaf_*.ipk
          opkg install /var/opkg/archives/open-app-filter_*.ipk
          opkg install /var/opkg/archives/luci-app-oaf_*.ipk
          opkg install /var/opkg/archives/luci-i18n-oaf-zh-cn_*.ipk
          
          # å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
          /etc/init.d/oaf enable
          /etc/init.d/oaf start
          /etc/init.d/uhttpd restart
          EOF
          
          chmod +x working_dir/etc/uci-defaults/95-install-oaf

      - name: é‡æ–°æ‰“åŒ…å›ºä»¶
        run: |
          # æ‰“åŒ…ä¿®æ”¹åŽçš„å›ºä»¶
          tar -zcf final_firmware.tar.gz -C working_dir .
          
          # éªŒè¯æœ€ç»ˆå›ºä»¶
          if [ ! -s "final_firmware.tar.gz" ]; then
            echo "é”™è¯¯ï¼šå›ºä»¶æ‰“åŒ…å¤±è´¥"
            exit 1
          fi

      - name: ä¸Šä¼ æœ€ç»ˆå›ºä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: istoreos-oaf-${{ github.run_id }}
          name: iStoreOS with OAF
          body: |
            ## iStoreOS å·²é›†æˆOAFé˜²æ²‰è¿·æ’ä»¶
            - ç½‘ç»œæ¨¡å¼: ${{ inputs.network_mode }}
            - IPåœ°å€: ${{ inputs.network_mode == 'static' && inputs.static_ip || 'DHCPè‡ªåŠ¨èŽ·å–' }}
            - OAFç‰ˆæœ¬: 1.0.2
          files: |
            final_firmware.tar.gz
            oaf_files/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
